{% set config = repository('Plugin\\UnivaPay\\Entity\\Config').findOneById(1) %}
{% set subscriptionTotal = 0 %}
{% set subscriptionPeriod = 4 %}
{% for item in Order.OrderItems %}
    {% if item.ProductClass %}
        {% if item.ProductClass.SubscriptionPeriod %}
            {% set subscriptionPeriod = item.ProductClass.SubscriptionPeriod.id %}
        {% endif %}
        {% set subscriptionTotal = subscriptionTotal + (item.ProductClass.price01_inc_tax * item.quantity) %}
    {% endif %}
{% endfor %}

{% set subscriptionTotal = subscriptionTotal == 0 ? Order.payment_total : Order.delivery_fee_total + subscriptionTotal %}
{{ form_widget(form.univa_pay_subscription_id) }}

<script src="{{ config.getWidgetUrl() }}/client/checkout.js"></script>
<script>
    form = document.querySelector("#shopping-form");
    subscriptionId = document.querySelector("#shopping_order_univa_pay_subscription_id");
    // this is strange, fix this later
    form.appendChild(subscriptionId);
    isSuccess = false;
    checkout = UnivapayCheckout.create({
        appId: "{{ config.getAppId() }}",
        checkout: "payment",
        amount: {{ subscriptionTotal }},
        currency: "{{ Order.currency_code }}",
        email: "{{ Order.email }}",
        metadata: { 
            subscriptionOrderNo: "{{ Order.order_no }}",
            items: [
                {% for item in Order.getOrderItems() %}
                `productName: {{ item.product_name }}, price: {{ item.price }}, quantity: {{ item.quantity }}`{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        },
        tokenType: "subscription",
        {% if subscriptionPeriod == 1 %}
            subscriptionPeriod: 'daily',
        {% elseif subscriptionPeriod == 2 %}
            subscriptionPeriod: 'weekly',
        {% elseif subscriptionPeriod == 3 %}
            subscriptionPeriod: 'biweekly',
        {% elseif subscriptionPeriod == 4 %}
            subscriptionPeriod: 'monthly',
        {% elseif subscriptionPeriod == 5 %}
            subscriptionPeriod: 'bimonthly',
        {% elseif subscriptionPeriod == 6 %}
            subscriptionPeriod: 'quarterly',
        {% elseif subscriptionPeriod == 7 %}
            subscriptionPeriod: 'semiannually',
        {% elseif subscriptionPeriod == 8 %}
            subscriptionPeriod: 'annually',
        {% endif %}
        capture: '{{ config.getCapture() }}' === '1',
        subscriptionInitialAmount: {{ Order.payment_total }},
        onSuccess: (result) => {
            isSuccess = true;
            subscriptionId.value = result.response.id;
            form.submit();
        },
        onError: (e) => {
            alert(e.error.error.message);
            window.location.href = "{{ url('shopping') }}";
        },
        closed: () => {
            if(isSuccess === false) {
                alert(`{{ 'univa_pay.shopping.checkout.close'|trans }}`);
                window.location.href = "{{ url('shopping') }}";
            }
        }
    });
    form.addEventListener("submit", () => {
        event.preventDefault();
        checkout.open();
    });
</script>
